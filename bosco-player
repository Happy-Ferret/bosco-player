var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
/**
 *  Copyright 2017 darkoverlordofdata
 *
 * AMD loader
 *
 * @param root object
 * @returns module loader function define
 *
 */
var define = (function (modules) {
    return function (name, deps, callback) {
        modules[name] = { id: name, exports: {} };
        var args = [function (name) { return modules[name].exports; }, modules[name].exports];
        for (var i = 2; i < deps.length; i++)
            args.push(modules[deps[i]].exports);
        callback.apply(modules[name].exports, args);
    };
}({}));
define("Util", ["require", "exports"], function (require, exports) {
    "use strict";
    var Gio = imports.gi.Gio;
    var Gtk = imports.gi.Gtk;
    var Lang = imports.lang;
    var Util = (function () {
        function Util() {
        }
        Util.readFile = function (filename) {
            var file = Gio.file_new_for_path(filename);
            if (file.query_exists(null)) {
                var _a = file.load_contents(null), success = _a[0], data = _a[1], length_1 = _a[2];
                return data;
            }
            else {
                return null;
            }
        };
        Util.loadTemplate = function (name, path, children, params) {
            var klass = Lang.Class({
                Name: name,
                Extends: Gtk.ApplicationWindow,
                Template: Util.readFile(path),
                Children: children,
                _init: function (params) {
                    return this.parent(params);
                }
            });
            return new klass(params);
        };
        return Util;
    }());
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.default = Util;
});
define("Project", ["require", "exports"], function (require, exports) {
    "use strict";
    /*
     *
     * Project class -
     *
     *
     */
    var Project = (function () {
        function Project(data) {
            this.data = {};
            var lines = data.split('\n');
            for (var j = 0, len = lines.length; j < len; j++) {
                var line = lines[j];
                if (line === "")
                    continue;
                if (line[0] === "#")
                    continue;
                var _a = line.split(/\s*\:\s*/), key0 = _a[0], value = _a[1];
                var _b = [false, key0], readonly = _b[0], key = _b[1];
                if (key[0] === '*') {
                    _c = [true, key.substring(1)], readonly = _c[0], key = _c[1];
                }
                if (this.data[key] != null) {
                    if (!Array.isArray(this.data[key])) {
                        this.data[key] = [this.data[key]];
                    }
                    this.data[key].push({
                        value: value,
                        readonly: readonly
                    });
                }
                else {
                    this.data[key] = {
                        value: value,
                        readonly: readonly
                    };
                }
            }
            var _c;
        }
        Project.prototype.isArray = function (key) {
            return Array.isArray(this.data[key]);
        };
        Project.prototype.count = function (key) {
            return this.data[key].length;
        };
        Project.prototype.get = function (key, i) {
            if (i == null) {
                return this.data[key].value;
            }
            else {
                return this.data[key][i].value;
            }
        };
        Project.prototype.readonly = function (key, i) {
            if (i == null) {
                return this.data[key].readonly;
            }
            else {
                return this.data[key][i].readonly;
            }
        };
        return Project;
    }());
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.default = Project;
});
define("tabs/NotebookTab", ["require", "exports"], function (require, exports) {
    "use strict";
    var GObject = imports.gi.GObject;
    var Gtk = imports.gi.Gtk;
    var Pango = imports.gi.Pango;
    /*
     *
     * Abstract Class ProjectViewer -
     *
     * view autovala data
     *
     */
    var NotebookTab = (function () {
        /*
          * set the autovala project data
          * @param prj:Project
         */
        function NotebookTab(prj, status) {
            this.prj = prj;
            this.status = status;
            this.id = this.status.get_context_id(this.constructor.name);
        }
        /*
          *
          *  buildUI
          *
          *  sets up the base UI page for property display
          *  subclass must override & super this method
          *
         */
        NotebookTab.prototype.buildUI = function () {
            var _this = this;
            var bold, key, normal, readonly, value;
            this.listStore = new Gtk.ListStore();
            this.listStore.set_column_types([GObject.TYPE_STRING, GObject.TYPE_STRING, GObject.TYPE_STRING]);
            this.treeView = new Gtk.TreeView({
                expand: true,
                model: this.listStore
            });
            this.selection = this.treeView.get_selection();
            this.selection.connect('changed', function () {
                return _this.onSelectionChanged();
            });
            this.grid = new Gtk.Grid();
            key = new Gtk.TreeViewColumn({
                title: "Key"
            });
            value = new Gtk.TreeViewColumn({
                title: "Value"
            });
            readonly = new Gtk.TreeViewColumn({
                title: "Readonly"
            });
            bold = new Gtk.CellRendererText({
                weight: Pango.Weight.BOLD
            });
            normal = new Gtk.CellRendererText();
            key.pack_start(bold, true);
            value.pack_start(normal, true);
            readonly.pack_start(normal, true);
            key.add_attribute(bold, "text", 0);
            value.add_attribute(normal, "text", 1);
            readonly.add_attribute(normal, "text", 2);
            this.treeView.insert_column(key, 0);
            this.treeView.insert_column(value, 1);
            this.treeView.insert_column(readonly, 2);
            this.scrollView = new Gtk.ScrolledWindow({
                hscrollbar_policy: Gtk.PolicyType.NEVER,
                vscrollbar_policy: Gtk.PolicyType.AUTOMATIC
            });
            this.scrollView.add(this.treeView);
            return this.grid.attach(this.scrollView, 0, 0, 1, 1);
        };
        /*
          * Add data to the list store
          * call from subclass buildUI
         */
        NotebookTab.prototype.add = function (p1, p2, p3) {
            return this.listStore.set(this.listStore.append(), [0, 1, 2], [String(p1), String(p2), String(p3)]);
        };
        /*
          * show the current selected row
         */
        NotebookTab.prototype.onSelectionChanged = function () {
            _a = this.selection.get_selected(), isSelected = _a[0], model = _a[1], iter = _a[2];
            return this.status.push(this.id, this.listStore.get_value(iter, 0)
                + " " + this.listStore.get_value(iter, 1)
                + " " + this.listStore.get_value(iter, 2));
            var _a;
        };
        return NotebookTab;
    }());
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.default = NotebookTab;
});
define("tabs/SourceTab", ["require", "exports", "tabs/NotebookTab"], function (require, exports, NotebookTab_1) {
    "use strict";
    var GObject, Gtk, Pango, SourceTab, extend = function (child, parent) { for (var key in parent) {
        if (hasProp.call(parent, key))
            child[key] = parent[key];
    } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; }, hasProp = {}.hasOwnProperty;
    GObject = imports.gi.GObject;
    Gtk = imports.gi.Gtk;
    Pango = imports.gi.Pango;
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.default = SourceTab = (function (superClass) {
        extend(SourceTab, superClass);
        function SourceTab() {
            return SourceTab.__super__.constructor.apply(this, arguments);
        }
        SourceTab.prototype.buildUI = function () {
            var i, item, len, ref;
            SourceTab.__super__.buildUI.call(this);
            ref = this.prj.data.vala_source;
            for (i = 0, len = ref.length; i < len; i++) {
                item = ref[i];
                this.add(item.value, "", item.readonly);
            }
            return this.grid;
        };
        return SourceTab;
    })(NotebookTab_1.default);
});
define("tabs/PackageTab", ["require", "exports", "tabs/NotebookTab"], function (require, exports, NotebookTab_2) {
    "use strict";
    var GObject = imports.gi.GObject;
    var Gtk = imports.gi.Gtk;
    var Pango = imports.gi.Pango;
    /*
     *
     * ProjectViewer class -
     *
     * view autovala data
     *
     */
    var PackageTab = (function (_super) {
        __extends(PackageTab, _super);
        function PackageTab(prj, status) {
            _super.call(this, prj, status);
        }
        PackageTab.prototype.buildUI = function () {
            // var i, item, len, ref
            _super.prototype.buildUI.call(this);
            for (var _i = 0, _a = this.prj.data.vala_check_package; _i < _a.length; _i++) {
                var item = _a[_i];
                this.add(item.value, "", item.readonly);
            }
            return this.grid;
        };
        return PackageTab;
    }(NotebookTab_2.default));
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.default = PackageTab;
});
define("tabs/ResourceTab", ["require", "exports", "tabs/NotebookTab"], function (require, exports, NotebookTab_3) {
    "use strict";
    var GObject, Gtk, Pango, ResourceTab, extend = function (child, parent) { for (var key in parent) {
        if (hasProp.call(parent, key))
            child[key] = parent[key];
    } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; }, hasProp = {}.hasOwnProperty;
    GObject = imports.gi.GObject;
    Gtk = imports.gi.Gtk;
    Pango = imports.gi.Pango;
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.default = ResourceTab = (function (superClass) {
        extend(ResourceTab, superClass);
        function ResourceTab() {
            return ResourceTab.__super__.constructor.apply(this, arguments);
        }
        ResourceTab.prototype.buildUI = function () {
            var i, item, len, name, path, ref, ref1;
            ResourceTab.__super__.buildUI.call(this);
            if (this.prj.data.gresource != null) {
                ref = this.prj.data.gresource;
                for (i = 0, len = ref.length; i < len; i++) {
                    item = ref[i];
                    ref1 = String(item.value).split(' '), name = ref1[0], path = ref1[1];
                    this.add(name, path, item.readonly);
                }
            }
            return this.grid;
        };
        return ResourceTab;
    })(NotebookTab_3.default);
});
define("tabs/AutovalaTab", ["require", "exports", "tabs/NotebookTab"], function (require, exports, NotebookTab_4) {
    "use strict";
    var GObject = imports.gi.GObject;
    var Gtk = imports.gi.Gtk;
    var Pango = imports.gi.Pango;
    /*
     *
     * ProjectViewer class -
     *
     * view autovala data
     *
     */
    var AutovalaTab = (function (_super) {
        __extends(AutovalaTab, _super);
        function AutovalaTab() {
            _super.apply(this, arguments);
        }
        AutovalaTab.prototype.costructor = function (prj, status) {
            _super.call(this, prj, status);
        };
        AutovalaTab.prototype.buildUI = function () {
            _super.prototype.buildUI.call(this);
            var ref = this.prj.data;
            for (var key in ref) {
                var item = ref[key];
                if (!Array.isArray(item)) {
                    this.add(key, item.value, item.readonly);
                }
            }
            return this.grid;
        };
        return AutovalaTab;
    }(NotebookTab_4.default));
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.default = AutovalaTab;
});
define("Application", ["require", "exports", "Util", "Project", "tabs/SourceTab", "tabs/PackageTab", "tabs/ResourceTab", "tabs/AutovalaTab"], function (require, exports, Util_1, Project_1, SourceTab_1, PackageTab_1, ResourceTab_1, AutovalaTab_1) {
    "use strict";
    var GLib = imports.gi.GLib;
    var Gio = imports.gi.Gio;
    var Gtk = imports.gi.Gtk;
    var Notify = imports.gi.Notify;
    var Application = (function () {
        function Application(params) {
            this.params = params;
            var path = PREFIX + "/player.ui";
            this.window = Util_1.default.loadTemplate('AppWindow', path, ['background', 'status'], this.params);
            this.regularCss = new Gtk.CssProvider();
            this.regularCss.load_from_data("* { font-family: Dejavu;  font-size: medium }");
            this.logoCss = new Gtk.CssProvider();
            this.logoCss.load_from_data("* { font-family: OpenDyslexic;  font-size: 32px }");
        }
        /*
         * buildUI
         *
         * @param config
         */
        Application.prototype.buildUI = function (config) {
            this.config = config;
            this.headerbar = new Gtk.HeaderBar({
                title: config.app_name,
                show_close_button: true
            });
            this.headerbar.pack_start(this.buildOpen(config));
            this.headerbar.pack_end(this.buildOptions(config));
            this.window.background.add(this.buildBackground());
            this.window.set_default_size(1040, 620);
            this.window.set_titlebar(this.headerbar);
            this.window.set_icon_from_file(PREFIX + "/bosco.png");
            return this.window.show_all();
        };
        /*
         * builds the Application Menu
         *
         * main app menu
         */
        Application.prototype.buildAppMenu = function () {
            var _this = this;
            var menu = new Gio.Menu();
            menu.append("New", 'app.new');
            menu.append("About", 'app.about');
            menu.append("Quit", 'app.quit');
            this.application.set_app_menu(menu);
            var newAction = new Gio.SimpleAction({
                name: 'new'
            });
            newAction.connect('activate', function () {
                return _this.showNew();
            });
            this.application.add_action(newAction);
            var aboutAction = new Gio.SimpleAction({
                name: 'about'
            });
            aboutAction.connect('activate', function () {
                return _this.showAbout();
            });
            this.application.add_action(aboutAction);
            var quitAction = new Gio.SimpleAction({
                name: 'quit'
            });
            quitAction.connect('activate', function () {
                return _this.window.destroy();
            });
            this.application.add_action(quitAction);
        };
        /*
         * builds the client background
         *
         * @param config
         */
        Application.prototype.buildBackground = function (config) {
            var background = new Gtk.Box();
            background.set_vexpand(true);
            background.set_hexpand(true);
            var label = new Gtk.Label({
                label: "Bosco Player"
            });
            background.set_center_widget(label);
            background.get_style_context().add_provider(this.logoCss, 0);
            return this.background = background;
        };
        /*
         * build open project button
         *
         * @param config
         */
        Application.prototype.buildOpen = function (config) {
            var _this = this;
            var openButton = new Gtk.Button();
            openButton.add(new Gtk.Image({
                icon_name: "document-open-symbolic",
                icon_size: Gtk.IconSize.SMALL_TOOLBAR
            }));
            openButton.connect("clicked", function () {
                var chooser = new Gtk.FileChooserDialog({
                    title: "Select Project File",
                    action: Gtk.FileChooserAction.OPEN,
                    transient_for: _this.window,
                    modal: true
                });
                chooser.set_select_multiple(false);
                chooser.add_button("Open", Gtk.ResponseType.OK);
                chooser.add_button("Cancel", Gtk.ResponseType.CANCEL);
                chooser.set_default_response(Gtk.ResponseType.OK);
                chooser.connect("response", function (dialog, response) {
                    _this.projectPath = dialog.get_filenames()[0];
                    dialog.destroy();
                    return _this.displayProject(_this.projectPath);
                });
                return chooser.run();
            });
            return openButton;
        };
        /*
         * display project
         *
         * @param path
         */
        Application.prototype.displayProject = function (path) {
            this.projectFile = Gio.File.new_for_path(path);
            if (!this.projectFile.query_exists(null)) {
                return;
            }
            if (this.notebook != null) {
                this.window.background.remove(this.notebook);
            }
            else {
                this.window.background.remove(this.background);
            }
            this.window.background.add(this.buildNotebook());
            var _a = this.projectFile.load_contents(null), success = _a[0], data = _a[1], length = _a[2];
            this.avprj = new Project_1.default(String(data));
            path = path.substring(0, path.lastIndexOf("/"));
            this.entitasFile = Gio.File.new_for_path(path + "/entitas.json");
            if (this.entitasFile.query_exists(null)) {
                var _b = this.entitasFile.load_contents(null), success_1 = _b[0], data_1 = _b[1], length_2 = _b[2];
                this.entitas = JSON.parse(data_1);
            }
            else {
                this.entitas = null;
            }
            this.window.set_title((this.avprj.get('project_name')) + " - " + this.config.app_name);
            this.avContent.pack_start(new AutovalaTab_1.default(this.avprj, this.window.status).buildUI(), true, true, 0);
            this.avContent.get_style_context().add_provider(this.regularCss, 0);
            this.resContent.pack_start(new ResourceTab_1.default(this.avprj, this.window.status).buildUI(), true, true, 0);
            this.resContent.get_style_context().add_provider(this.regularCss, 0);
            this.pkContent.pack_start(new PackageTab_1.default(this.avprj, this.window.status).buildUI(), true, true, 0);
            this.pkContent.get_style_context().add_provider(this.regularCss, 0);
            this.srcContent.pack_start(new SourceTab_1.default(this.avprj, this.window.status).buildUI(), true, true, 0);
            this.srcContent.get_style_context().add_provider(this.regularCss, 0);
            this.window.show_all();
        };
        /*
         * build notebook
         *
         */
        Application.prototype.buildNotebook = function () {
            var builder = new Gtk.Builder();
            builder.add_from_file(PREFIX + "/project.glade");
            var notebook = builder.get_object("project");
            var title = new Gtk.Label({
                label: "Autovala"
            });
            this.avContent = new Gtk.Box();
            notebook.append_page(this.avContent, title);
            title = new Gtk.Label({
                label: "GResources"
            });
            this.resContent = new Gtk.Box();
            notebook.append_page(this.resContent, title);
            title = new Gtk.Label({
                label: "Packages"
            });
            this.pkContent = new Gtk.Box();
            notebook.append_page(this.pkContent, title);
            title = new Gtk.Label({
                label: "Source"
            });
            this.srcContent = new Gtk.Box();
            notebook.append_page(this.srcContent, title);
            title = new Gtk.Label({
                label: "Entitas"
            });
            this.entitasContent = new Gtk.Box();
            notebook.append_page(this.entitasContent, title);
            return this.notebook = notebook;
        };
        /*
         * build project options editor
         *
         * @param config
         */
        Application.prototype.buildOptions = function (config) {
            var grid = new Gtk.Grid({
                column_spacing: 10,
                row_spacing: 10,
                margin: 10
            });
            grid.set_column_homogeneous(true);
            var namelabel = new Gtk.Label({
                label: "File name:"
            });
            namelabel.set_halign(Gtk.Align.END);
            var nameentry = new Gtk.Entry();
            nameentry.connect("changed", (function (_this) {
                return function () {
                    return config.res_name = nameentry.get_text();
                };
            })(this));
            nameentry.set_placeholder_text(config.res_name);
            grid.attach(namelabel, 0, 0, 1, 1);
            grid.attach_next_to(nameentry, namelabel, Gtk.PositionType.RIGHT, 2, 1);
            var prefixlabel = new Gtk.Label({
                label: "Resource prefix:"
            });
            prefixlabel.set_halign(Gtk.Align.END);
            var prefixentry = new Gtk.Entry();
            prefixentry.set_placeholder_text(config.res_prefix);
            prefixentry.connect("changed", function () {
                return prefixentry.get_text();
            });
            grid.attach(prefixlabel, 0, 1, 1, 1);
            grid.attach_next_to(prefixentry, prefixlabel, Gtk.PositionType.RIGHT, 2, 1);
            var menubutton = new Gtk.ToggleButton();
            menubutton.add(new Gtk.Image({
                icon_name: "open-menu-symbolic",
                icon_size: Gtk.IconSize.SMALL_TOOLBAR
            }));
            menubutton.connect("clicked", function () {
                if (menubutton.get_active()) {
                    menu.show_all();
                }
            });
            var menu = new Gtk.Popover();
            menu.set_relative_to(menubutton);
            menu.connect("show", function () {
                nameentry.set_text(config.res_name);
                return prefixentry.set_text(config.res_prefix);
            });
            menu.connect("closed", function () {
                var outputstream, parent, res_prefix;
                if (menubutton.get_active()) {
                    menubutton.set_active(false);
                }
                config.res_name = config.res_name || config.res_name;
                res_prefix = res_prefix || config.res_prefix;
                var write = false;
                if (config.res_name !== config.res_name) {
                    config.res_name = config.res_name;
                    write = true;
                }
                if (config.res_prefix !== res_prefix) {
                    config.res_prefix = res_prefix;
                    write = true;
                }
                if (write) {
                    parent = config_file.get_parent();
                    if (parent.query_exists(null)) {
                        if (config_file.query_exists(null)) {
                            config_file["delete"](null);
                        }
                    }
                    else {
                        parent.make_directory_with_parents(null);
                    }
                    outputstream = config_file.create(Gio.FileCreateFlags.REPLACE_DESTINATION, null);
                    outputstream.write_all(JSON.stringify(config), null);
                    outputstream.close(null);
                }
            });
            menu.add(grid);
            return menubutton;
        };
        return Application;
    }());
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.default = Application;
});
define("Player", ["require", "exports", "Util", "Application"], function (require, exports, Util_2, Application_1) {
    "use strict";
    var GLib = imports.gi.GLib;
    var Gio = imports.gi.Gio;
    var Gtk = imports.gi.Gtk;
    /*
     * Bosco Player
     *
     * top level application object
     */
    var Player = (function () {
        function Player() {
            var _this = this;
            this.application = new Gtk.Application({
                flags: Gio.ApplicationFlags.FLAGS_NONE
            });
            this.application.connect('activate', function () {
                _this.buildUI();
                _this.appWindow = new Application_1.default({
                    application: _this.application
                });
                _this.appWindow.buildUI(_this.getConfig());
                _this.window = _this.appWindow.window;
                _this.window.present();
            });
        }
        /*
         * build the Application Menu
         *
         * main app menu
         */
        Player.prototype.buildUI = function () {
            var _this = this;
            var menu = new Gio.Menu();
            menu.append("New", 'app.new');
            menu.append("About", 'app.about');
            menu.append("Quit", 'app.quit');
            this.application.set_app_menu(menu);
            var newAction = new Gio.SimpleAction({
                name: 'new'
            });
            newAction.connect('activate', function () {
                return _this.showNew();
            });
            this.application.add_action(newAction);
            var aboutAction = new Gio.SimpleAction({
                name: 'about'
            });
            aboutAction.connect('activate', function () {
                return _this.showAbout();
            });
            this.application.add_action(aboutAction);
            var quitAction = new Gio.SimpleAction({
                name: 'quit'
            });
            quitAction.connect('activate', function () {
                return _this.window.destroy();
            });
            this.application.add_action(quitAction);
        };
        /*
         * New project dialog
         */
        Player.prototype.showNew = function () {
            return print("Not implemented");
        };
        /*
         * About dialog
         */
        Player.prototype.showAbout = function () {
            var about = new Gtk.AboutDialog();
            about.set_transient_for(this.window);
            about.set_program_name("Bosco Player");
            about.set_version("1.0");
            about.set_comments("If it's not dark, it's not data");
            about.set_website("");
            about.set_website_label("Dark Overlord of Data");
            about.set_authors(["bruce davidson"]);
            about.run();
            return about.destroy();
        };
        /*
         * load configuration
         */
        Player.prototype.getConfig = function () {
            var res_name_default = "custom.gresource";
            var res_prefix_default = "/com/darkoverlordofdata/custom";
            var data = Util_2.default.readFile(GLib.get_user_data_dir() + "/bosco/config.json");
            var config = data != null ? JSON.parse(data) : {};
            config.app_name = "Player";
            var ref;
            config.res_name = (ref = config.res_name) != null ? ref : res_name_default;
            config.res_prefix = (ref = config.res_prefix) != null ? ref : res_prefix_default;
            return config;
        };
        return Player;
    }());
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.default = Player;
});
define("main", ["require", "exports", "Player"], function (require, exports, Player_1) {
    "use strict";
    new Player_1.default().application.run(ARGV);
});
